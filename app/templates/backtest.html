{% extends "base.html" %}

{% block title %}Backtest - {{ config.label }} - Notificador IOF MG{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{{ url_for('web.detail_config', config_id=config.id) }}" class="text-blue-600 hover:text-blue-800 mb-4 inline-block">
        <i class="fas fa-arrow-left mr-2"></i>Voltar para detalhes
    </a>
    <h2 class="text-3xl font-bold text-gray-800">Testar Busca: {{ config.label }}</h2>
    <p class="text-gray-600 mt-2">Teste sua configuração de busca em uma data específica do Diário Oficial</p>
</div>

<!-- Formulário de Backtest -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <form method="POST" id="backtestForm">
        <div class="flex items-end gap-4">
            <div class="flex-1">
                <label for="date" class="block text-sm font-medium text-gray-700 mb-2">
                    Data do Diário <span class="text-red-500">*</span>
                </label>
                <input type="date" id="date" name="date" 
                       value="{% if test_date %}{{ test_date.isoformat() }}{% endif %}"
                       {% if max_date %}max="{{ max_date }}"{% endif %}
                       required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <p class="mt-1 text-xs text-gray-500">Selecione uma data para testar a busca</p>
            </div>
            <button type="submit" id="executeBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition">
                <i class="fas fa-vial mr-2"></i>Executar Teste
            </button>
        </div>
    </form>
</div>

<!-- Resultados -->
{% if result %}
<div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-chart-bar mr-2 text-blue-500"></i>Resultados do Teste
        <span class="ml-auto text-lg font-bold {% if result.count > 0 %}text-green-600{% else %}text-gray-600{% endif %}">
            {{ result.count }} resultado(s) encontrado(s)
        </span>
    </h3>

    {% if result.count > 0 %}
    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800">
            <strong>Data testada:</strong> {{ result.publish_date }} | 
            <strong>Termos buscados:</strong> 
            {% for term in result.search_terms %}
                {{ term.term }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </p>
    </div>

    <div class="space-y-4">
        {% for highlight in result.highlights %}
        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center">
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">
                        Página {{ highlight.page }}
                    </span>
                    <span class="ml-3 px-3 py-1 bg-gray-100 text-gray-800 rounded text-sm">
                        Termo: {{ highlight.term }}
                    </span>
                </div>
            </div>
            <div class="mt-3 p-3 bg-gray-50 rounded border-l-4 border-blue-500">
                <p class="text-gray-800">{{ highlight.content }}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
        <h4 class="text-xl font-semibold text-gray-600 mb-2">Nenhum resultado encontrado</h4>
        <p class="text-gray-500">Nenhum dos termos configurados foi encontrado no Diário Oficial desta data.</p>
    </div>
    {% endif %}
</div>
{% else %}
<div class="bg-white rounded-lg shadow-md p-6 text-center py-12">
    <i class="fas fa-vial text-6xl text-gray-300 mb-4"></i>
    <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhum teste executado ainda</h3>
    <p class="text-gray-500">Selecione uma data e clique em "Executar Teste" para ver os resultados</p>
</div>
{% endif %}
{% endblock %}
